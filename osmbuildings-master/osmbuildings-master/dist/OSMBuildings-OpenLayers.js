const OSMBuildings=function(){const e=Math,t=e.exp,i=e.log,r=e.sin,a=e.cos,s=e.tan,o=e.atan,n=e.atan2,l=e.min,c=e.max,h=e.sqrt,f=e.ceil,d=e.pow;class u{constructor(e,t,i,r=1){this.r=this._clamp(e,1),this.g=this._clamp(t,1),this.b=this._clamp(i,1),this.a=this._clamp(r,1)}static parse(e){if("string"==typeof e){let t;if(e=e.toLowerCase(),t=(e=u.w3cColors[e]||e).match(/^#?(\w{2})(\w{2})(\w{2})$/))return new u(parseInt(t[1],16)/255,parseInt(t[2],16)/255,parseInt(t[3],16)/255);if(t=e.match(/^#?(\w)(\w)(\w)$/))return new u(parseInt(t[1]+t[1],16)/255,parseInt(t[2]+t[2],16)/255,parseInt(t[3]+t[3],16)/255);if(t=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new u(parseFloat(t[1])/255,parseFloat(t[2])/255,parseFloat(t[3])/255,t[4]?parseFloat(t[5]):1)}return new u}static fromHSL(e,t,i,r){const a=(new u).fromHSL(e,t,i);return a.a=void 0===r?1:r,a}_hue2rgb(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e}_clamp(e,t){if(void 0!==e)return Math.min(t,Math.max(0,e||0))}isValid(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b}toHSL(){if(!this.isValid())return;const e=Math.max(this.r,this.g,this.b),t=Math.min(this.r,this.g,this.b),i=e-t,r=(e+t)/2;if(!i)return{h:0,s:0,l:r};const a=r>.5?i/(2-e-t):i/(e+t);let s;switch(e){case this.r:s=(this.g-this.b)/i+(this.g<this.b?6:0);break;case this.g:s=(this.b-this.r)/i+2;break;case this.b:s=(this.r-this.g)/i+4}return s*=60,{h:s,s:a,l:r}}fromHSL(e,t,i){if(0===t)return this.r=this.g=this.b=i,this;const r=i<.5?i*(1+t):i+t-i*t,a=2*i-r;return e/=360,this.r=this._hue2rgb(a,r,e+1/3),this.g=this._hue2rgb(a,r,e),this.b=this._hue2rgb(a,r,e-1/3),this}toString(){if(this.isValid())return 1===this.a?"#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1,7):`rgba(${Math.round(255*this.r)},${Math.round(255*this.g)},${Math.round(255*this.b)},${this.a.toFixed(2)})`}toArray(){if(this.isValid)return[this.r,this.g,this.b]}hue(e){const t=this.toHSL();return this.fromHSL(t.h+e,t.s,t.l)}saturation(e){const t=this.toHSL();return this.fromHSL(t.h,t.s*e,t.l)}lightness(e){const t=this.toHSL();return this.fromHSL(t.h,t.s,t.l*e)}clone(){return new u(this.r,this.g,this.b,this.a)}}function p(){const e=Math,t=e.PI,i=e.sin,r=e.cos,a=e.tan,s=e.asin,o=e.atan2,n=t/180,l=23.4397*n;function c(e,t,s){return o(i(e),r(e)*i(t)-a(s)*r(t))}function h(e,t,a){return s(i(t)*i(a)+r(t)*r(a)*r(e))}return function(e,f,d){const u=n*-d,p=n*f,g=function(e){return function(e){return e.valueOf()/864e5-.5+2440588}(e)-2451545}(e),y=function(e){return n*(357.5291+.98560028*e)}(g),m=function(e,i){return e+i+102.9372*n+t}(y,function(e){return n*(1.9148*i(e)+.02*i(2*e)+3e-4*i(3*e))}(y)),x=(k=m,s(i(_=0)*r(l)+r(_)*i(l)*i(k))),b=function(e,t){return o(i(e)*r(l)-a(t)*i(l),r(e))}(m,0),w=function(e,t){return n*(280.16+360.9856235*e)-t}(g,u)-b;var k,_;return{altitude:h(w,p,x),azimuth:c(w,p,x)-t/2}}}u.w3cColors={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgrey:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},"undefined"!=typeof module&&(module.exports=u);const g={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},y={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"};function m(e){return"#"===(e=e.toLowerCase())[0]?e:g[y[e]||e]||null}function x(e,t){if(function(e){let t,i,r,a,s=0;for(let o=0,n=e.length-3;o<n;o+=2)t=e[o],i=e[o+1],r=e[o+2],a=e[o+3],s+=t*a-r*i;return s/2>0?"CW":"CCW"}(e)===t)return e;let i=[];for(let t=e.length-2;t>=0;t-=2)i.push(e[t],e[t+1]);return i}function b(e){const t={};e=e||{},t.height=e.height||(e.levels?3*e.levels:G),t.minHeight=e.minHeight||(e.minLevel?3*e.minLevel:0);const i=e.material?m(e.material):e.wallColor||e.color;i&&(t.wallColor=i);const r=e.roofMaterial?m(e.roofMaterial):e.roofColor;switch(r&&(t.roofColor=r),e.shape){case"cylinder":case"cone":case"dome":case"sphere":t.shape=e.shape,t.isRotational=!0;break;case"pyramid":t.shape=e.shape}switch(e.roofShape){case"cone":case"dome":t.roofShape=e.roofShape,t.isRotational=!0;break;case"pyramid":t.roofShape=e.roofShape}return t.roofShape&&e.roofHeight?(t.roofHeight=e.roofHeight,t.height=c(0,t.height-t.roofHeight)):t.roofHeight=0,t}function w(e){let t,i,r=[];switch(e.type){case"GeometryCollection":r=[];for(let t=0,a=e.geometries.length;t<a;t++)(i=w(e.geometries[t]))&&r.push.apply(r,i);return r;case"MultiPolygon":r=[];for(let t=0,a=e.coordinates.length;t<a;t++)(i=w({type:"Polygon",coordinates:e.coordinates[t]}))&&r.push.apply(r,i);return r;case"Polygon":t=e.coordinates;break;default:return[]}let a,s=[],o=[];a=t[0];for(let e=0,t=a.length;e<t;e++)s.push(a[e][1],a[e][0]);s=x(s,"CW");for(let e=0,i=t.length-1;e<i;e++){a=t[e+1],o[e]=[];for(let t=0,i=a.length;t<i;t++)o[e].push(a[t][1],a[t][0]);o[e]=x(o[e],"CCW")}return[{outer:s,inner:o.length?o:null}]}function k(e){let t={};for(const i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}let _,v,H,S,C,M,T=Math.PI,P=T/2,I=T/4,j=0,O=0,A=0,L=0,z=0,F=0,D=u.parse("rgba(200, 190, 180)"),R=D.lightness(.8),q=D.lightness(1.2),N=""+D,E=""+R,X=""+q,B=0,G=5;function V(e,t){const i=e.x-t.x,r=e.y-t.y;return i*i+r*r}function $(e,t,i,r,a,s){let o,n=a-i,l=s-r;return 0===n&&0===l||(o=((e-i)*n+(t-r)*l)/(n*n+l*l),o>1?(i=a,r=s):o>0&&(i+=n*o,r+=l*o)),n=e-i,l=t-r,n*n+l*l}function W(e){let t=180,i=-180;for(let r=0,a=e.length;r<a;r+=2)t=l(t,e[r+1]),i=c(i,e[r+1]);return(i-t)/2}function J(e,i){const r={};return e/=v,i/=v,r.latitude=i<=0?90:i>=1?-90:function(e){return e/T*180}(2*o(t(T*(1-2*i)))-P),r.longitude=360*(1===e?1:(e%1+1)%1)-180,r}function Z(e,t){const r=l(1,c(0,.5-i(s(I+P*e/180))/T/2));return{x:(t/360+.5)*v<<0,y:r*v<<0}}function Y(e){const t=j+z,i=O+F;for(let r=0,a=e.length-3;r<a;r+=2)if(e[r]>z&&e[r]<t&&e[r+1]>F&&e[r+1]<i)return!0;return!1}let U,K={},Q=[],ee=0;class te{static getPixelFootprint(e){let t,i=new Int32Array(e.length);for(let r=0,a=e.length-1;r<a;r+=2)t=Z(e[r],e[r+1]),i[r]=t.x,i[r+1]=t.y;if(i=function(e){let t,i,r,a=e.length/2,s=new Uint8Array(a),o=0,n=a-1,l=[],c=[],h=[];for(s[o]=s[n]=1;n;){t=0;for(let a=o+1;a<n;a++)i=$(e[2*a],e[2*a+1],e[2*o],e[2*o+1],e[2*n],e[2*n+1]),i>t&&(r=a,t=i);t>2&&(s[r]=1,l.push(o),c.push(r),l.push(r),c.push(n)),o=l.pop(),n=c.pop()}for(let t=0;t<a;t++)s[t]&&h.push(e[2*t],e[2*t+1]);return h}(i),!(i.length<8))return i}static resetItems(){this.items=[],this.cache={},ce.reset()}static addRenderItems(e,t){let i,r,a,s=class{static read(e){if(!e||"FeatureCollection"!==e.type)return[];const t=e.features,i=[];for(let e=0,r=t.length;e<r;e++){const r=t[e];if("Feature"!==r.type)continue;const a=b(r.properties),s=w(r.geometry);for(let e=0,t=s.length;e<t;e++){const t=k(a);t.footprint=s[e].outer,t.isRotational&&(t.radius=W(t.footprint)),s[e].inner&&(t.holes=s[e].inner),(r.id||r.properties.id)&&(t.id=r.id||r.properties.id),r.properties.relationId&&(t.relationId=r.properties.relationId),i.push(t)}}return i}}.read(e);for(let e=0,o=s.length;e<o;e++)i=s[e],a=i.id||[i.footprint[0],i.footprint[1],i.height,i.minHeight].join(","),this.cache[a]||(r=this.scaleItem(i))&&(r.scale=t?0:1,this.items.push(r),this.cache[a]=1);!function(){if(U)return;U=setInterval(e=>{let t=te.items,i=!1;for(let e=0,r=t.length;e<r;e++)t[e].scale<1&&(t[e].scale+=.1,t[e].scale>1&&(t[e].scale=1),i=!0);se.render(),i||(clearInterval(U),U=null)},33)}()}static scalePolygon(e,t){return e.map(e=>e*t)}static scale(e){te.items=te.items.map(t=>{if(t.height*=e,t.minHeight*=e,t.footprint=te.scalePolygon(t.footprint,e),t.center.x*=e,t.center.y*=e,t.radius&&(t.radius*=e),t.holes)for(let i=0,r=t.holes.length;i<r;i++)t.holes[i]=te.scalePolygon(t.holes[i],e);return t.roofHeight*=e,t})}static scaleItem(e){let t,i={},r=6/d(2,_-15);if(e.id&&(i.id=e.id),i.height=l(e.height/r,H),i.minHeight=isNaN(e.minHeight)?0:e.minHeight/r,!(i.minHeight>H)&&(i.footprint=this.getPixelFootprint(e.footprint),i.footprint)){if(i.center=function(e){let t=1/0,i=-1/0,r=1/0,a=-1/0;for(let s=0,o=e.length-3;s<o;s+=2)t=l(t,e[s]),i=c(i,e[s]),r=l(r,e[s+1]),a=c(a,e[s+1]);return{x:t+(i-t)/2<<0,y:r+(a-r)/2<<0}}(i.footprint),e.radius&&(i.radius=e.radius*B),e.shape&&(i.shape=e.shape),e.roofShape&&(i.roofShape=e.roofShape),"cone"!==i.roofShape&&"dome"!==i.roofShape||i.shape||!function(e){const t=e.length;if(t<16)return!1;let i=1/0,r=-1/0,a=1/0,s=-1/0;for(let o=0;o<t-1;o+=2)i=Math.min(i,e[o]),r=Math.max(r,e[o]),a=Math.min(a,e[o+1]),s=Math.max(s,e[o+1]);const o=r-i,n=s-a,l=o/n;if(l<.85||l>1.15)return!1;const c={x:i+o/2,y:a+n/2},h=(o+n)/4,f=h*h;for(let i=0;i<t-1;i+=2){const t=V({x:e[i],y:e[i+1]},c);if(t/f<.8||t/f>1.2)return!1}return!0}(i.footprint)||(i.shape="cylinder"),e.holes){let t;i.holes=[];for(let r=0,a=e.holes.length;r<a;r++)(t=this.getPixelFootprint(e.holes[r]))&&i.holes.push(t)}return e.wallColor&&(t=u.parse(e.wallColor))&&(i.altColor=""+t.lightness(.8),i.wallColor=""+t),e.roofColor&&(t=u.parse(e.roofColor))&&(i.roofColor=""+t),e.relationId&&(i.relationId=e.relationId),i.hitColor=ce.idToColor(e.relationId||e.id),i.roofHeight=isNaN(e.roofHeight)?0:e.roofHeight/r,i.height+i.roofHeight<=i.minHeight?void 0:i}}static set(e){this.resetItems(),this._staticData=e,this.addRenderItems(this._staticData,!0)}static load(e,t){this.src=e||"https://{s}.data.osmbuildings.org/0.2/{k}/tile/{z}/{x}/{y}.json".replace("{k}",t||"anonymous"),this.update()}static update(){if(this.resetItems(),!(_<15)&&(this._staticData&&this.addRenderItems(this._staticData),this.src)){let t,i,r=16,a=256,s=_>r?a<<_-r:a>>r-_,o=z/s<<0,n=F/s<<0,l=f((z+j)/s),c=f((F+O)/s),h=this;function e(e){h.addRenderItems(e)}for(i=n;i<=c;i++)for(t=o;t<=l;t++)this.loadTile(t,i,r,e)}}static loadTile(e,t,i,r){let a="abcd"[(e+t)%4],s=this.src.replace("{s}",a).replace("{x}",e).replace("{y}",t).replace("{z}",i);return class{static loadJSON(e,t){return function(e,t){if(K[e])return void(t&&t(K[e]));const i=new XMLHttpRequest;return i.onreadystatechange=function(){if(4===i.readyState&&!(!i.status||i.status<200||i.status>299)&&t&&i.responseText){const r=i.responseText;for(K[e]=r,Q.push({url:e,size:r.length}),ee+=r.length,t(r);ee>5242880;){let e=Q.shift();ee-=e.size,delete K[e.url]}}},i.open("GET",e),i.send(null),i}(e,e=>{let i;try{i=JSON.parse(e)}catch(e){}t(i)})}}.loadJSON(s,r)}}te.cache={},te.items=[];class ie{static draw(e,t,i,r,a,s,o,n){let l=this._extrude(e,t,r,a,s,o),c=[];if(i)for(let t=0,n=i.length;t<n;t++)c[t]=this._extrude(e,i[t],r,a,s,o);if(e.fillStyle=n,e.beginPath(),this._ring(e,l),i)for(let t=0,i=c.length;t<i;t++)this._ring(e,c[t]);e.closePath(),e.fill()}static _extrude(e,t,i,r,a,s){let o,n,l=450/(450-i),c=450/(450-r),h={x:0,y:0},f={x:0,y:0},d=[];for(let i=0,u=t.length-3;i<u;i+=2)h.x=t[i]-z,h.y=t[i+1]-F,f.x=t[i+2]-z,f.y=t[i+3]-F,o=oe.project(h,l),n=oe.project(f,l),r&&(h=oe.project(h,c),f=oe.project(f,c)),(f.x-h.x)*(o.y-h.y)>(o.x-h.x)*(f.y-h.y)&&(h.x<f.x&&h.y<f.y||h.x>f.x&&h.y>f.y?e.fillStyle=s:e.fillStyle=a,e.beginPath(),this._ring(e,[f.x,f.y,h.x,h.y,o.x,o.y,n.x,n.y]),e.closePath(),e.fill()),d[i]=o.x,d[i+1]=o.y;return d}static _ring(e,t){e.moveTo(t[0],t[1]);for(let i=2,r=t.length-1;i<r;i+=2)e.lineTo(t[i],t[i+1])}static simplified(e,t,i){if(e.beginPath(),this._ringAbs(e,t),i)for(let t=0,r=i.length;t<r;t++)this._ringAbs(e,i[t]);e.closePath(),e.fill()}static _ringAbs(e,t){e.moveTo(t[0]-z,t[1]-F);for(let i=2,r=t.length-1;i<r;i+=2)e.lineTo(t[i]-z,t[i+1]-F)}static shadow(e,t,i,r,a){let s,o,n=null,l={x:0,y:0},c={x:0,y:0};for(let i=0,h=t.length-3;i<h;i+=2)l.x=t[i]-z,l.y=t[i+1]-F,c.x=t[i+2]-z,c.y=t[i+3]-F,s=le.project(l,r),o=le.project(c,r),a&&(l=le.project(l,a),c=le.project(c,a)),(c.x-l.x)*(s.y-l.y)>(s.x-l.x)*(c.y-l.y)?(1===n&&e.lineTo(l.x,l.y),n=0,i||e.moveTo(l.x,l.y),e.lineTo(c.x,c.y)):(0===n&&e.lineTo(s.x,s.y),n=1,i||e.moveTo(s.x,s.y),e.lineTo(o.x,o.y));if(i)for(let t=0,r=i.length;t<r;t++)this._ringAbs(e,i[t])}static hitArea(e,t,i,r,a,s){let o,n,l=null,c={x:0,y:0},h={x:0,y:0},f=450/(450-r),d=450/(450-a);e.fillStyle=s,e.beginPath();for(let i=0,r=t.length-3;i<r;i+=2)c.x=t[i]-z,c.y=t[i+1]-F,h.x=t[i+2]-z,h.y=t[i+3]-F,o=oe.project(c,f),n=oe.project(h,f),a&&(c=oe.project(c,d),h=oe.project(h,d)),(h.x-c.x)*(o.y-c.y)>(o.x-c.x)*(h.y-c.y)?(1===l&&e.lineTo(c.x,c.y),l=0,i||e.moveTo(c.x,c.y),e.lineTo(h.x,h.y)):(0===l&&e.lineTo(o.x,o.y),l=1,i||e.moveTo(o.x,o.y),e.lineTo(n.x,n.y));e.closePath(),e.fill()}}class re{static draw(e,t,i,r,a,s,o,l,c){let h,f,d={x:t.x-z,y:t.y-F},u=450/(450-a),p=450/(450-s),g=oe.project(d,u);r*=u,s&&(d=oe.project(d,p),i*=p);let y=this._tangents(d,i,g,r);y?(h=n(y[0].y1-d.y,y[0].x1-d.x),f=n(y[1].y1-d.y,y[1].x1-d.x)):(h=1.5*T,f=1.5*T),e.fillStyle=o,e.beginPath(),e.arc(g.x,g.y,r,P,h,!0),e.arc(d.x,d.y,i,h,P),e.closePath(),e.fill(),e.fillStyle=l,e.beginPath(),e.arc(g.x,g.y,r,f,P,!0),e.arc(d.x,d.y,i,P,f),e.closePath(),e.fill(),e.fillStyle=c,this._circle(e,g,r)}static simplified(e,t,i){this._circle(e,{x:t.x-z,y:t.y-F},i)}static shadow(e,t,i,r,a,s){let o,l,c={x:t.x-z,y:t.y-F},h=le.project(c,a);s&&(c=le.project(c,s));let f=this._tangents(c,i,h,r);f?(o=n(f[0].y1-c.y,f[0].x1-c.x),l=n(f[1].y1-c.y,f[1].x1-c.x),e.moveTo(f[1].x2,f[1].y2),e.arc(h.x,h.y,r,l,o),e.arc(c.x,c.y,i,o,l)):(e.moveTo(c.x+i,c.y),e.arc(c.x,c.y,i,0,2*T))}static hitArea(e,t,i,r,a,s,o){let l,c,h={x:t.x-z,y:t.y-F},f=450/(450-a),d=450/(450-s),u=oe.project(h,f);r*=f,s&&(h=oe.project(h,d),i*=d);let p=this._tangents(h,i,u,r);e.fillStyle=o,e.beginPath(),p?(l=n(p[0].y1-h.y,p[0].x1-h.x),c=n(p[1].y1-h.y,p[1].x1-h.x),e.moveTo(p[1].x2,p[1].y2),e.arc(u.x,u.y,r,c,l),e.arc(h.x,h.y,i,l,c)):(e.moveTo(h.x+i,h.y),e.arc(h.x,h.y,i,0,2*T)),e.closePath(),e.fill()}static _circle(e,t,i){e.beginPath(),e.arc(t.x,t.y,i,0,2*T),e.fill()}static _tangents(e,t,i,r){let a=e.x-i.x,s=e.y-i.y,o=t-r,n=a*a+s*s;if(n<=o*o)return;let l,f,d,u=h(n),p=-a/u,g=-s/u,y=o/u,m=[];l=h(c(0,1-y*y));for(let a=1;a>=-1;a-=2)f=p*y-a*l*g,d=g*y+a*l*p,m.push({x1:e.x+t*f<<0,y1:e.y+t*d<<0,x2:i.x+r*f<<0,y2:i.y+r*d<<0});return m}}class ae{static draw(e,t,i,r,a,s,o){let n={x:i.x-z,y:i.y-F},l=450/(450-r),c=450/(450-a),h=oe.project(n,l),f={x:0,y:0},d={x:0,y:0};for(let i=0,r=t.length-3;i<r;i+=2)f.x=t[i]-z,f.y=t[i+1]-F,d.x=t[i+2]-z,d.y=t[i+3]-F,a&&(f=oe.project(f,c),d=oe.project(d,c)),(d.x-f.x)*(h.y-f.y)>(h.x-f.x)*(d.y-f.y)&&(f.x<d.x&&f.y<d.y||f.x>d.x&&f.y>d.y?e.fillStyle=o:e.fillStyle=s,e.beginPath(),this._triangle(e,f,d,h),e.closePath(),e.fill())}static _triangle(e,t,i,r){e.moveTo(t.x,t.y),e.lineTo(i.x,i.y),e.lineTo(r.x,r.y)}static _ring(e,t){e.moveTo(t[0]-z,t[1]-F);for(let i=2,r=t.length-1;i<r;i+=2)e.lineTo(t[i]-z,t[i+1]-F)}static shadow(e,t,i,r,a){let s={x:0,y:0},o={x:0,y:0},n={x:i.x-z,y:i.y-F},l=le.project(n,r);for(let i=0,r=t.length-3;i<r;i+=2)s.x=t[i]-z,s.y=t[i+1]-F,o.x=t[i+2]-z,o.y=t[i+3]-F,a&&(s=le.project(s,a),o=le.project(o,a)),(o.x-s.x)*(l.y-s.y)>(l.x-s.x)*(o.y-s.y)&&this._triangle(e,s,o,l)}static hitArea(e,t,i,r,a,s){let o={x:i.x-z,y:i.y-F},n=450/(450-r),l=450/(450-a),c=oe.project(o,n),h={x:0,y:0},f={x:0,y:0};e.fillStyle=s,e.beginPath();for(let i=0,r=t.length-3;i<r;i+=2)h.x=t[i]-z,h.y=t[i+1]-F,f.x=t[i+2]-z,f.y=t[i+3]-F,a&&(h=oe.project(h,l),f=oe.project(f,l)),(f.x-h.x)*(c.y-h.y)>(c.x-h.x)*(f.y-h.y)&&this._triangle(e,h,f,c);e.closePath(),e.fill()}}class se{static init(){se.container.className="osmb-container",le.init(se.createContext(se.container)),ne.init(se.createContext(se.container)),oe.init(se.createContext(se.container)),ce.init(se.createContext())}static clear(){le.clear(),ne.clear(),oe.clear(),ce.clear()}static setOpacity(e){le.setOpacity(e),ne.setOpacity(e),oe.setOpacity(e),ce.setOpacity(e)}static render(e){_<15?se.clear():M||requestAnimationFrame(t=>{e||(le.render(),ne.render()),oe.render()})}static createContext(e){let t=document.createElement("CANVAS");t.className="osmb-layer";let i=t.getContext("2d");return i.lineCap="round",i.lineJoin="round",i.lineWidth=1,i.imageSmoothingEnabled=!1,se.items.push(t),e&&e.appendChild(t),i}static appendTo(e){e.appendChild(se.container)}static remove(){se.container.parentNode.removeChild(se.container)}static setSize(e,t){se.items.forEach(i=>{i.width=e,i.height=t})}static setPosition(e,t){se.container.style.left=e+"px",se.container.style.top=t+"px"}}se.container=document.createElement("DIV"),se.items=[];class oe{static init(e){this.context=e}static clear(){this.context.clearRect(0,0,j,O)}static setOpacity(e){this.context.canvas.style.opacity=e}static project(e,t){return{x:(e.x-S)*t+S<<0,y:(e.y-C)*t+C<<0}}static render(){this.clear();let e,t,i,r,a,s,o,n=this.context,l={x:S+z,y:C+F},c=te.items;c.sort((e,t)=>e.minHeight-t.minHeight||V(t.center,l)-V(e.center,l)||t.height-e.height);for(let l=0,h=c.length;l<h;l++)if(e=c[l],!ne.isSimple(e)&&(r=e.footprint,Y(r))){switch(t=e.scale<1?e.height*e.scale:e.height,i=0,e.minHeight&&(i=e.scale<1?e.minHeight*e.scale:e.minHeight),a=e.wallColor||N,s=e.altColor||E,o=e.roofColor||X,n.strokeStyle=s,e.shape){case"cylinder":re.draw(n,e.center,e.radius,e.radius,t,i,a,s,o);break;case"cone":re.draw(n,e.center,e.radius,0,t,i,a,s);break;case"dome":re.draw(n,e.center,e.radius,e.radius/2,t,i,a,s);break;case"sphere":re.draw(n,e.center,e.radius,e.radius,t,i,a,s,o);break;case"pyramid":ae.draw(n,r,e.center,t,i,a,s);break;default:ie.draw(n,r,e.holes,t,i,a,s,o)}switch(e.roofShape){case"cone":re.draw(n,e.center,e.radius,0,t+e.roofHeight,t,o,""+u.parse(o).lightness(.9));break;case"dome":re.draw(n,e.center,e.radius,e.radius/2,t+e.roofHeight,t,o,""+u.parse(o).lightness(.9));break;case"pyramid":ae.draw(n,r,e.center,t+e.roofHeight,t,o,u.parse(o).lightness(.9))}}}}class ne{static init(e){this.context=e}static clear(){this.context.clearRect(0,0,j,O)}static setOpacity(e){this.context.canvas.style.opacity=e}static isSimple(e){return _<=ne.MAX_ZOOM&&e.height+e.roofHeight<ne.MAX_HEIGHT}static render(){this.clear();let e=this.context;if(_>ne.MAX_ZOOM)return;let t,i,r=te.items;for(let a=0,s=r.length;a<s;a++)if(t=r[a],!(t.height>=ne.MAX_HEIGHT)&&(i=t.footprint,Y(i)))switch(e.strokeStyle=t.altColor||E,e.fillStyle=t.roofColor||X,t.shape){case"cylinder":case"cone":case"dome":case"sphere":re.simplified(e,t.center,t.radius);break;default:ie.simplified(e,i,t.holes)}}}ne.MAX_ZOOM=16,ne.MAX_HEIGHT=5;class le{static init(e){this.context=e}static clear(){this.context.clearRect(0,0,j,O)}static setOpacity(e){this.opacity=e}static project(e,t){return{x:e.x+this.direction.x*t,y:e.y+this.direction.y*t}}static render(){this.clear();let e,t,i,o,n=this.context;if(e=J(A+z,L+F),t=p(this.date,e.latitude,e.longitude),t.altitude<=0)return;i=1/s(t.altitude),o=i<5?.75:1/i*5,this.direction.x=a(t.azimuth)*i,this.direction.y=r(t.azimuth)*i;let l,c,h,f,d,u,g=te.items;for(n.canvas.style.opacity=o/(2*this.opacity),n.shadowColor=this.blurColor,n.fillStyle=this.color,n.beginPath(),l=0,c=g.length;l<c;l++)if(h=g[l],u=h.footprint,Y(u)){switch(f=h.scale<1?h.height*h.scale:h.height,d=0,h.minHeight&&(d=h.scale<1?h.minHeight*h.scale:h.minHeight),h.shape){case"cylinder":re.shadow(n,h.center,h.radius,h.radius,f,d);break;case"cone":re.shadow(n,h.center,h.radius,0,f,d);break;case"dome":re.shadow(n,h.center,h.radius,h.radius/2,f,d);break;case"sphere":re.shadow(n,h.center,h.radius,h.radius,f,d);break;case"pyramid":ae.shadow(n,u,h.center,f,d);break;default:ie.shadow(n,u,h.holes,f,d)}switch(h.roofShape){case"cone":re.shadow(n,h.center,h.radius,0,f+h.roofHeight,f);break;case"dome":re.shadow(n,h.center,h.radius,h.radius/2,f+h.roofHeight,f);break;case"pyramid":ae.shadow(n,u,h.center,f+h.roofHeight,f)}}n.closePath(),n.fill()}}le.color="#666666",le.blurColor="#000000",le.date=new Date,le.direction={x:0,y:0},le.opacity=1;class ce{static init(e){this.context=e}static setOpacity(e){}static clear(){}static reset(){this._idMapping=[null]}static render(){if(this._timer)return;let e=this;this._timer=setTimeout(t=>{e._timer=null,e._render()},500)}static _render(){this.clear();let e,t,i,r,a,s=this.context,o={x:S+z,y:C+F},n=te.items;n.sort((e,t)=>e.minHeight-t.minHeight||V(t.center,o)-V(e.center,o)||t.height-e.height);for(let o=0,l=n.length;o<l;o++)if(e=n[o],(a=e.hitColor)&&(r=e.footprint,Y(r))){switch(t=e.height,i=0,e.minHeight&&(i=e.minHeight),e.shape){case"cylinder":re.hitArea(s,e.center,e.radius,e.radius,t,i,a);break;case"cone":re.hitArea(s,e.center,e.radius,0,t,i,a);break;case"dome":re.hitArea(s,e.center,e.radius,e.radius/2,t,i,a);break;case"sphere":re.hitArea(s,e.center,e.radius,e.radius,t,i,a);break;case"pyramid":ae.hitArea(s,r,e.center,t,i,a);break;default:ie.hitArea(s,r,e.holes,t,i,a)}switch(e.roofShape){case"cone":re.hitArea(s,e.center,e.radius,0,t+e.roofHeight,t,a);break;case"dome":re.hitArea(s,e.center,e.radius,e.radius/2,t+e.roofHeight,t,a);break;case"pyramid":ae.hitArea(s,r,e.center,t+e.roofHeight,t,a)}}j&&O&&(this._imageData=this.context.getImageData(0,0,j,O).data)}static getIdFromXY(e,t){let i=this._imageData;if(!i)return;let r=4*((0|t)*j+(0|e)),a=i[r]|i[r+1]<<8|i[r+2]<<16;return this._idMapping[a]}static idToColor(e){let t=this._idMapping.indexOf(e);return-1===t&&(this._idMapping.push(e),t=this._idMapping.length-1),"rgb("+[255&t,t>>8&255,t>>16&255].join(",")+")"}}ce._idMapping=[null];function he(e){S=A+e.x,C=O+e.y,se.render(!0)}function fe(e){j=e.width,O=e.height,A=j/2<<0,L=O/2<<0,S=A,C=O,se.setSize(j,O),H=400}function de(e){_=e,v=256<<_;const t=J(z+A,F+L),i=Z(t.latitude,0),r=Z(t.latitude,1);B=r.x-i.x,se.setOpacity(Math.pow(.95,_-15)),N=""+D,E=""+R,X=""+q}class ue extends ol.layer.Layer{constructor(e){super(ue.name,{projection:"EPSG:900913"}),this.offset={x:0,y:0},se.init(),e&&e.addLayer(this)}addTo(e){return this.setMap(e),this}setOrigin(){let e=this.map,t=e.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),i=e.resolution,r=this.maxExtent;!function(e){z=e.x,F=e.y}({x:(t.lon-r.left)/i<<0,y:(r.top-t.lat)/i<<0})}setMap(e){this.map||super.setMap.call(this,e),se.appendTo(this.div),fe({width:e.size.w,height:e.size.h}),de(e.zoom),this.setOrigin();let t=this.projection;e.events.register("click",e,i=>{let r=ce.getIdFromXY(i.xy.x,i.xy.y);if(r){let r=e.getLonLatFromPixel(i.xy).transform(t,this.projection);r.lat,r.lon}}),te.update()}removeMap(e){se.remove(),super.removeMap.call(this,e),this.map=null}onMapResize(){let e=this.map;super.onMapResize.call(this),fe({width:e.size.w,height:e.size.h}),se.render(),te.update()}moveTo(e,t,i){let r=this.map,a=super.moveTo.call(this,e,t,i);if(!i){let e=parseInt(r.layerContainerDiv.style.left,10),t=parseInt(r.layerContainerDiv.style.top,10);this.div.style.left=-e+"px",this.div.style.top=-t+"px"}return this.setOrigin(),this.offset.x=0,this.offset.y=0,he(this.offset),t?function(e){M=!1;const t=Math.pow(2,e.zoom-_);de(e.zoom),_<=15?se.clear():(te.scale(t),le.render(),ne.render(),oe.render(),te.update())}({zoom:r.zoom}):(se.render(),te.update()),a}moveByPx(e,t){this.offset.x+=e,this.offset.y+=t;let i=super.moveByPx.call(this,e,t);return he(this.offset),i}}return ue.name="OSM Buildings",ue.attribution='&copy; <a href="https://osmbuildings.org">OSM Buildings</a>',ue.isBaseLayer=!1,ue.alwaysInRange=!0,ue}();